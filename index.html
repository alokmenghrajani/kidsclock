<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    @font-face {
      font-family: Roboto;
      src: url(Roboto-Thin.ttf);
    }

    body {
      font-family: Roboto;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      align-items: center;
      position: fixed;
    }

    #main {
      flex-grow: 1;
      display: flex;
      flex-direction: row;
      justify-content: center;
    }

    #footer {
      padding: 1em;
    }

    svg {
      width: 100%;
      height: 100%;
    }

    #form {
      padding: 1em;
      justify-self: center;
      align-self: center;
      font-size: 5vh;
    }

    input {
      font-size: 5vh;
    }

    select {
      font-size: 3vh;
    }

    #score {
      white-space: nowrap;
    }

    svg text {
      user-select: none;
      pointer-events: none;
    }

    svg circle {
      pointer-events: none;
    }

    small {
      font-size: 3vh;
    }
  </style>
</head>

<body>
  <div id="main">
    <svg id="svg" viewBox="-100 -100 200 200" stroke="#000" fill="none" xmlns="http://www.w3.org/2000/svg"></svg>
    <div id="form">
      <p><select id="levelPicker" onChange="kidsClock.changeLevel()">
          <option id="level--0" value="0">level 1</option>
          <option id="level--1" value="1" disabled>level 2</option>
          <option id="level--2" value="2" disabled>level 3</option>
          <option id="level--3" value="3" disabled>level 4</option>
          <option id="level--4" value="4" disabled>level 5</option>
          <option id="level--5" value="5" disabled>level 6</option>
          <option id="level--6" value="6" disabled>level 7</option>
          <option id="level--7" value="7" disabled>level 8</option>
          <option id="level--8" value="8" disabled>level 9</option>
        </select></p>
      <div>
        <nobr>Time?</nobr>
      </div>
      <div><input id="input" type="text" placeholder="hh:mm" size="6" onChange="kidsClock.validateInput()"></div>
      <div id="score"></div>
    </div>
  </div>
  <small id="footer">A game to help kids learn how to read analog clocks. 🇨🇭 Swiss made.</small>
  <script src="svgjs/svg.min.js"></script>
  <script>
// TODO:
// - click/touch on hands
// - consider making angularTime number of seconds since noon/midnight.
// - rewrite validate input. Use angularTime?
// - do something when the user gets the input wrong.
// - force user to type enter.
// - figure out mobile UI
// - confetti or something when you switch from one level to another
// - force user input to be 1-12 for hours and 0-59 for minutes.

    class KidsClock {
      constructor() {
        this.level = 0;
        this.maxLevel = 0;
        this.score = Array(9).fill(0)

        // We track time in "angularTime", which is essentially the number of degrees the
        // hour hand has moved since 12:00. There's 4320 angularTime degrees per half-day.
        // AngularTime makes handling clicks and touch events easier.
        this.angularTime = 0;

        // List of elements which needs to be redrawn when the time changes
        this.elements = [];

        // Draw the elements which don't change when the time changes or between levels
        this.draw = SVG(svg);
        this.draw.circle(180).center(0, 0);
        this.draw.on('mousemove', e => this.mouseMove(e));
        this.draw.on('mouseup', e => this.mouseUp(e));
      }

      setAngularTime(t) {
        this.angularTime = t % (12 * 360);
        if (this.angularTime < 0) {
          // If angularTime was negative, modulo remains negative.
          this.angularTime += 12 * 360;
        }
        this.update(this.angularTime);
        input.value = "";
      }

      incrementScore() {
        this.score[this.level]++;
        if (this.score[this.level] > 5) {
          this.score[this.level] = 5;
        }
        if (this.score[this.level] == 5) {
          this.level++;
          if (this.level > 8) {
            this.level = 8;
          }
        }
        if (this.level > this.maxLevel) {
          // TODO: show confetti
          this.maxLevel = this.level;
        }

        localStorage.setItem('score', JSON.stringify(this.score));
        localStorage.setItem('level', this.level);
        localStorage.setItem('maxLevel', this.maxLevel);
        this.reload();
      }

      changeLevel() {
        this.level = levelPicker.value | 0;
        localStorage.setItem('level', this.level);
        this.reload();
      }

      reload() {
        levelPicker.value = this.level;
        for (let i = 0; i <= this.maxLevel; i++) {
          document.getElementById("level--" + i).disabled = false;
        }

        const icons = ["⭐", "😛", "🍄", "🐚", "🌻", "🦋", "🧸", "🏆", "🐐"];
        score.innerText = Array(this.score[this.level]).fill(icons[this.level]).join('');

        switch (this.level) {
          case 0:
            {
              // hours and minutes on clock face.
              this.minutesText = true;
              this.minutesDotStyle = "style-1";
              this.hoursText = "arabic";

              // hours and minutes highlight.
              this.minutesHighlight = true;
              this.hoursHighlight = true;

              // minutes/hours are color coded.
              this.colors = true;

              // minutes are 0, 15, 30, or 45.
              const hour = (Math.random() * 12) | 0;
              const min = ((Math.random() * 4) | 0) * 15;
              this.setAngularTime(hour * 360 + min * 6);
              break;
            }
          case 1:
            {
              // hours and minutes on clock face.
              this.minutesText = true;
              this.minutesDotStyle = "style-1";
              this.hoursText = "arabic";

              // hours and minutes highlight.
              this.minutesHighlight = true;
              this.hoursHighlight = true;

              // minutes/hours are color coded.
              this.colors = true;

              // minutes are 0, 5, 10, 15, ...
              const hour = (Math.random() * 12) | 0;
              const min = ((Math.random() * 12) | 0) * 5;
              this.setAngularTime(hour * 360 + min * 6);
              break;
            }
          case 2:
            {
              // hours and minutes on clock face.
              this.minutesText = true;
              this.minutesDotStyle = "style-2";
              this.hoursText = "arabic";

              // no more highlights
              this.minutesHighlight = false;
              this.hoursHighlight = false;

              // minutes/hours are color coded.
              this.colors = true;

              // minutes can be anything
              const hour = (Math.random() * 12) | 0;
              const min = (Math.random() * 60) | 0;
              this.setAngularTime(hour * 360 + min * 6);
              break;
            }
          case 3:
            {
              // no more minutes on the clock face.
              this.minutesText = false;
              this.minutesDotStyle = "style-1";

              // everything else is the same as previous level
              this.hoursText = "arabic";
              this.minutesHighlight = false;
              this.hoursHighlight = false;
              this.colors = true;
              const hour = (Math.random() * 12) | 0;
              const min = (Math.random() * 60) | 0;
              this.setAngularTime(hour * 360 + min * 6);
              break;
            }
          case 4:
            {
              // roman numerals
              this.hoursText = "roman";

              // everything else is the same as previous level
              this.minutesText = false;
              this.minutesDotStyle = "style-1";
              this.minutesHighlight = false;
              this.hoursHighlight = false;
              this.colors = true;
              const hour = (Math.random() * 12) | 0;
              const min = (Math.random() * 60) | 0;
              this.setAngularTime(hour * 360 + min * 6);
              break;
            }
          case 5:
            {
              // only 12, 3, 6, 9 for hours
              this.hoursText = "arabic-2";

              // no more color coding
              this.colors = false;

              // everything else is the same as previous level
              this.minutesText = false;
              this.minutesDotStyle = "style-1";
              this.minutesHighlight = false;
              this.hoursHighlight = false;
              const hour = (Math.random() * 12) | 0;
              const min = (Math.random() * 60) | 0;
              this.setAngularTime(hour * 360 + min * 6);
              break;
            }
          case 6:
            {
              // only 12 for hours
              this.hoursText = "arabic-3";

              // everything else is the same as previous level
              this.colors = false;
              this.minutesText = false;
              this.minutesDotStyle = "style-1";
              this.minutesHighlight = false;
              this.hoursHighlight = false;
              const hour = (Math.random() * 12) | 0;
              const min = (Math.random() * 60) | 0;
              this.setAngularTime(hour * 360 + min * 6);
              break;
            }
          case 7:
            {
              // only 12 for hours and different style for minute dots
              this.hoursText = "arabic-3";
              this.minutesDotStyle = "style-3";

              // everything else is the same as previous level
              this.colors = false;
              this.minutesText = false;
              this.minutesHighlight = false;
              this.hoursHighlight = false;

              // minutes are 0, 15, 30, or 45.
              const hour = (Math.random() * 12) | 0;
              const min = ((Math.random() * 4) | 0) * 15;
              this.setAngularTime(hour * 360 + min * 6);
              break;
            }
          case 8:
            {
              // only 12 for hours and different style for minute dots
              this.hoursText = "arabic-2";
              this.minutesDotStyle = "style-4";

              // everything else is the same as previous level
              this.colors = false;
              this.minutesText = false;
              this.minutesHighlight = false;
              this.hoursHighlight = false;

              // minutes can be anything
              const hour = (Math.random() * 12) | 0;
              const min = (Math.random() * 60) | 0;
              this.setAngularTime(hour * 360 + min * 6);
              break;
            }
          default:
            throw new Error("unknown level: " + this.level);
        }
      }

      validateInput() {
        const minAngle = this.angularTime % 360;
        const min = Math.floor(minAngle / 6);
        const hourAngle = this.angularTime / 12;
        let hour = Math.floor(hourAngle / 30);

        let delta1 = 9999;
        let m = input.value.match(/^([0-9]{1,2})[^0-9]([0-9]{1,2})$/);
        if (m) {
          delta1 = Math.abs((hour * 60 + min) - (m[1] * 60 + (m[2]|0)))
        } else {
          m = input.value.match(/^([0-9]{1,2})([0-9]{2,2})$/);
          if (m) {
            delta1 = Math.abs((hour * 60 + min) - (m[1] * 60 + (m[2]|0)))
          }
        }
        const delta2 = Math.abs(720 - delta1);
        const delta = Math.min(delta1, delta2);
        if (delta == 0) {
          this.incrementScore();
          return;
        }

        if ((this.level == 9) && (delta <= 5)) {
          this.incrementScore();
          return;
        }

        // TODO: animate error
        // TODO: remove
        console.log(hour, ":", min, "...", delta);
      }

      update(angularTime) {
        // remove elements which will get recreated
        for (let i = 0; i < this.elements.length; i++) {
          this.elements[i].remove();
        }
        this.elements = [];

        const minAngle = angularTime % 360;
        const min = Math.floor(minAngle / 6);

        const hourAngle = angularTime / 12;
        const hour = Math.floor(hourAngle / 30);

        // draw minutes, from 5 to 60
        if (this.minutesText) {
          for (let i = 0; i < 60; i += 5) {
            let t = i;
            if (i == 0) {
              t = 60;
            }
            if ((this.level >= 2) && (i == 5)) {
              t = "05";
            }
            if ((this.level >= 3) && (i == 0)) {
              t = "";
            }
            const text = this.draw.text(t)
              .font({ size: 8 })
              .center(0, 0)
              .rotate(i * 6, 0, 76)
              .translate(0, -76)
              .stroke('none');
            if (this.colors) {
              text.fill('#0a0');
            } else {
              text.fill('#000');
            }
            if ((i >= 20) && (i <= 40)) {
              // rotate 20 thru 40 for better legibility
              text.rotate(180);
            }
            this.elements.push(text);
          }
        }

        // draw dots and lines for each minute
        if (this.minutesDotStyle == "style-3") {
          for (let i = 0; i < 12; i++) {
            const el = this.draw.circle(2)
              .center(63, 0)
              .rotate(i * 30, 0, 0)
              .stroke('none');
            if (this.colors) {
              el.fill('#0a0');
            } else {
              el.fill('#000');
            }
            this.elements.push(el);
          }
        } else if (this.minutesDotStyle == "style-4") {
          for (let i = 0; i < 4; i++) {
            const el = this.draw.circle(2)
              .center(63, 0)
              .rotate(i * 90, 0, 0)
              .stroke('none');
            if (this.colors) {
              el.fill('#0a0');
            } else {
              el.fill('#000');
            }
            this.elements.push(el);
          }
        } else {
          for (let i = 0; i < 60; i++) {
            let el
            if (i % 5 == 0) {
              if ((i == 0) && (this.minutesDotStyle == "style-2")) {
                el = this.draw.polygon().rotate(-90 + i * 6, 0, 0);
                el.plot([[60, 0], [66, -2], [66, 2]]);
              } else {
                el = this.draw.line(60, 0, 66, 0).rotate(-90 + i * 6, 0, 0);
              }
              if (this.colors) {
                if (this.minutesHighlight) {
                  if (i == min) {
                    el.stroke({ width: 2, color: '#0a0' });
                  } else {
                    el.stroke({ width: 2, color: '#afa' });;
                  }
                } else {
                  el.stroke({ width: 2, color: '#0a0' });
                }
              } else {
                el.stroke({ width: 2, color: '#000' });
              }
            } else {
              el = this.draw.circle(2)
                .center(63, 0)
                .rotate(-90 + i * 6, 0, 0)
                .stroke('none');
              if (this.colors) {
                if (this.minutesHighlight) {
                  if (i == min) {
                    el.fill('#0a0');
                  } else {
                    el.fill('#afa');
                  }
                } else {
                  el.fill('#0a0');
                }
              } else {
                el.fill('#000');
              }
            }
            this.elements.push(el);
          }
        }

        // draw hour text
        if (this.hoursText == "arabic") {
          for (let i = 0; i < 12; i++) {
            let t = i;
            if (i == 0) {
              t = 12;
            }

            const l = this.minutesText ? 50 : 77;
            const text = this.draw.text(t)
              .center(0, 0)
              .rotate(i * 30, 0, l)
              .translate(0, -l)
              .rotate(-i * 30, 0, 0)
              .stroke('none');
            if (this.colors) {
              if (this.minutesHighlight) {
                if (i == hour) {
                  text.fill('#00a');
                } else {
                  text.fill('#aaf');
                }
              } else {
                text.fill('#00a');
              }
            } else {
              text.fill('#000');
            }
            this.elements.push(text);
          }
        } else if (this.hoursText == "arabic-2") {
          for (let i = 0; i < 4; i++) {
            let t = i * 3;
            if (i == 0) {
              t = 12;
            }

            const l = this.minutesText ? 50 : 77;
            const text = this.draw.text(t)
              .center(0, 0)
              .rotate(i * 90, 0, l)
              .translate(0, -l)
              .rotate(-i * 90, 0, 0)
              .stroke('none');
            if (this.colors) {
              if (this.minutesHighlight) {
                if (i == hour) {
                  text.fill('#00a');
                } else {
                  text.fill('#aaf');
                }
              } else {
                text.fill('#00a');
              }
            } else {
              text.fill('#000');
            }
            this.elements.push(text);
          }
        } else if (this.hoursText == "arabic-3") {
          const l = this.minutesText ? 50 : 77;
          const text = this.draw.text("12")
            .center(0, 0)
            .translate(0, -l)
            .stroke('none');
          if (this.colors) {
            if (this.minutesHighlight) {
              if (i == hour) {
                text.fill('#00a');
              } else {
                text.fill('#aaf');
              }
            } else {
              text.fill('#00a');
            }
          } else {
            text.fill('#000');
          }
          this.elements.push(text);
        } else if (this.hoursText == "roman") {
          const t = ["XII", "III", "VI", "IX"];
          for (let i = 0; i < 4; i++) {
            const l = this.minutesText ? 50 : 77;
            const text = this.draw.text(t[i])
              .center(0, 0)
              .rotate(i * 90, 0, l)
              .translate(0, -l)
              .stroke('none');
            text.fill('#00a');
            this.elements.push(text);
          }
        }

        // draw minute hand
        const minHand = this.drawHand(3, 60, 6).rotate(-90 + minAngle, 0, 0);
        if (this.colors) {
          minHand.fill('#0a0');
        } else {
          minHand.fill('#aaa');
        }
        minHand.on('mousedown', e => this.minMouseDown(e));
        this.elements.push(minHand);

        // draw hour hand
        const hourHand = this.drawHand(6, 45, 6).rotate(-90 + hourAngle, 0, 0);
        if (this.colors) {
          hourHand.fill('#00a');
        } else {
          hourHand.fill('#666');
        }
        hourHand.on('mousedown', e => this.hourMouseDown(e));
        this.elements.push(hourHand);

        // draw pin which holds the hands in place
        this.elements.push(this.draw.circle(5).center(0, 0).fill('#333').stroke('none'));
      }

      drawHand(width, length, tail) {
        var polygon = this.draw.polygon().stroke('none');
        polygon.plot([[-tail, -width / 2], [length * 5 / 6, -width], [length, 0], [length * 5 / 6, width], [-tail, width / 2]])
        return polygon;
      }

      mouseMove(e) {
        // TODO: implement
      }

      mouseUp(e) {
        // TODO: implement
      }
    }

    //   minMouseDown(e) {
    //     if (this.minDrag || this.hourDrag) {
    //       // TODO: cancel previous drag state
    //       return;
    //     }
    //     this.minDrag = true;
    //     const pt = DOMPoint.fromPoint(this.draw);
    //     pt.x = e.x;
    //     pt.y = e.y;
    //     const pos = pt.matrixTransform(svg.getScreenCTM().inverse())
    //     this.prevMousePosition = pos;
    //     console.log("mouse down");
    //   }

    //   minMouseMove(e) {
    //     if (!this.minDrag) {
    //       // ignore mouse move if the initial mousedown event didn't start on the min hand
    //       return;
    //     }
    //     const pt = DOMPoint.fromPoint(this.draw);
    //     pt.x = e.x;
    //     pt.y = e.y;
    //     const pos = pt.matrixTransform(svg.getScreenCTM().inverse())

    //     // calculate angular difference
    //     const angle1 = Math.atan2(this.prevMousePosition.y, this.prevMousePosition.x);
    //     const angle2 = Math.atan2(pos.y, pos.x);
    //     let d = angle2 - angle1;

    //     // we want a value between -π and π, so we know if we are adding or
    //     // removing time.
    //     d = d % (2 * Math.PI);
    //     if (d > Math.PI) {
    //       d -= 2 * Math.PI;
    //     }
    //     if (d < -Math.PI) {
    //       d += 2 * Math.PI;
    //     }

    //     // convert angular difference to minutes
    //     const deltaMin = d / Math.PI * 30;

    //     // calculate new time and redraw hands
    //     let newHour = this.getHour();
    //     let newMin = this.getMin() + deltaMin;
    //     if (newMin < 0) {
    //       newHour -= 1;
    //       if (newHour < 0) {
    //         newHour += 12;
    //       }
    //       newMin += 60;
    //     }
    //     if (newMin >= 60) {
    //       newHour += 1;
    //       if (newHour >= 12) {
    //         newHour -= 12;
    //       }
    //       newMin -= 60;
    //     }
    //     if (newMin != this.timeMin) {
    //       this.timeMin = newMin;
    //       this.timeMin2 = 0;
    //       this.timeHour = newHour;
    //       this.prevMousePosition = pos;
    //     }
    //     this.drawHands(newHour, newMin | 0);

    //     console.log("mouse move");
    //   }

    //   minMouseUp(e) {
    //     if (!this.minDrag) {
    //       // ignore mouse up if the initial mousedown event didn't start on the min hand
    //       return;
    //     }
    //     this.minDrag = false;
    //     this.prevMousePosition = undefined;
    //     console.log("mouse up");
    //   }

    //   hourMouseDown(e) {
    //     if (this.minDrag || this.hourDrag) {
    //       // TODO: cancel previous drag state
    //       return;
    //     }
    //     this.hourDrag = true;
    //     const pt = DOMPoint.fromPoint(this.draw);
    //     pt.x = e.x;
    //     pt.y = e.y;
    //     const pos = pt.matrixTransform(svg.getScreenCTM().inverse())
    //     this.prevMousePosition = pos;
    //     console.log("hour mouse down");
    //   }

    //   hourMouseMove(e) {
    //     if (!this.hourDrag) {
    //       // ignore mouse move if the initial mousedown event didn't start on the hour hand
    //       return;
    //     }
    //     const pt = DOMPoint.fromPoint(this.draw);
    //     pt.x = e.x;
    //     pt.y = e.y;
    //     const pos = pt.matrixTransform(svg.getScreenCTM().inverse())

    //     // calculate angular difference
    //     const angle1 = Math.atan2(this.prevMousePosition.y, this.prevMousePosition.x);
    //     const angle2 = Math.atan2(pos.y, pos.x);
    //     let d = angle2 - angle1;

    //     // we want a value between -π and π, so we know if we are adding or
    //     // removing time.
    //     d = d % (2 * Math.PI);
    //     if (d > Math.PI) {
    //       d -= 2 * Math.PI;
    //     }
    //     if (d < -Math.PI) {
    //       d += 2 * Math.PI;
    //     }

    //     // convert angular difference to hours + minutes
    //     let deltaHour = d / Math.PI * 6;
    //     let frac = deltaHour - (deltaHour | 0);
    //     deltaHour = deltaHour | 0;
    //     const deltaMin = frac * 60;

    //     // calculate new time and redraw hands
    //     let newHour = this.getHour() + deltaHour;
    //     let newMin = this.getMin() + deltaMin;
    //     if (newMin < 0) {
    //       newHour -= 1;
    //       newMin += 60;
    //     }
    //     if (newMin >= 60) {
    //       newHour += 1;
    //       newMin -= 60;
    //     }
    //     if (newHour < 0) {
    //       newHour += 12;
    //     }
    //     if (newHour >= 12) {
    //       newHour -= 12;
    //     }
    //     if (newMin != this.timeMin) {
    //       this.timeMin = newMin;
    //       this.timeHour = newHour;
    //       this.prevMousePosition = pos;
    //     }
    //     this.drawHands(newHour, newMin | 0);
    //     console.log("mouse move");
    //   }

    //   hourMouseUp(e) {
    //     if (!this.hourDrag) {
    //       // ignore mouse up if the initial mousedown event didn't start on the hour hand
    //       return;
    //     }
    //     this.hourDrag = false;
    //     this.prevMousePosition = undefined;
    //     console.log("mouse up");
    //   }
    // }

    kidsClock = new KidsClock();

    // Read level+score from local storage
    const l = localStorage.getItem("level");
    if (l) {
      kidsClock.level = l|0;
    }

    const m = localStorage.getItem("maxLevel");
    if (m) {
      kidsClock.maxLevel = m|0;
    }

    const s = localStorage.getItem("score");
    if (s) {
      kidsClock.score = JSON.parse(s);
    }
    kidsClock.reload();
  </script>
</body>

</html>